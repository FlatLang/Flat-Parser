package flat/parser

import flat/parser/Parser
import flat/ast/FileNode
import flat/ast/PackageNode
import flat/io/File

testable class {
  async test `can parse package declaration`() {
    let parser = PackageParser()

    let request = ParseRequest(
      parent: FileNode(file: File("test.flat")),
      sourceCode: "package flat/thing/test"
    )

    let result = parser.parse(request)

    expect(result).toNotBe(null)
    expect(result.success).toBe(true)

    let expected = PackageNode(location: "flat/thing/test")

    expect(result.node).toBe(expected)
  }

  async test `can parse single letter package declaration`() {
    let parser = PackageParser()

    let request = ParseRequest(
      parent: FileNode(file: File("test.flat")),
      sourceCode: "package a"
    )

    let result = parser.parse(request)

    expect(result).toNotBe(null)
    expect(result.success).toBe(true)

    let expected = PackageNode(location: "a")

    expect(result.node).toBe(expected)
  }

  async test `fails parse if doesnt contain package keyword`() {
    let parser = PackageParser()

    let request = ParseRequest(
      parent: FileNode(file: File("test.flat"))
    )

    let results = Array<ParseResult>():addAll([
      parser.parse(request.copy(sourceCode: "parckage")),
      parser.parse(request.copy(sourceCode: " package")),
      parser.parse(request.copy(sourceCode: "test package"))
    ])

    results.forEachAsync((result) => {
      expect(result).toNotBe(null)
      expect(result.success).toBe(false)
      expect(result.errorMessage).toBe("Package declaration doesn't start with \"package\"")
    })
  }

  async test `fails parse if doesnt contain anything after the package keyword`() {
    let parser = PackageParser()

    let request = ParseRequest(
      parent: FileNode(file: File("test.flat"))
    )

    let results = Array<ParseResult>():addAll([
      parser.parse(request.copy(sourceCode: "package")),
      parser.parse(request.copy(sourceCode: "package "))
    ])

    results.forEachAsync((result) => {
      expect(result).toNotBe(null)
      expect(result.success).toBe(false)
      expect(result.errorMessage).toBe("Package declaration doesn't contain anything after the \"package\" keyword")
    })
  }

  async test `fails parse if doesnt have whitespace after the package keyword`() {
    let parser = PackageParser()

    let request = ParseRequest(
      parent: FileNode(file: File("test.flat"))
    )

    let results = Array<ParseResult>():addAll([
      parser.parse(request.copy(sourceCode: "package\"aoeu")),
      parser.parse(request.copy(sourceCode: "packageaoeu")),
      parser.parse(request.copy(sourceCode: "packagea test"))
    ])

    results.forEachAsync((result) => {
      expect(result).toNotBe(null)
      expect(result.success).toBe(false)
      expect(result.errorMessage).toBe("Package declaration doesn't have whitespace after the \"package\" keyword")
    })
  }
}
